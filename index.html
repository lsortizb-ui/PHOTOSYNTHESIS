<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador Fotos√≠ntesis ‚Äî Final</title>
<style>
  :root{
    --bg-top:#bfefff;
    --bg-bottom:#fff;
    --ui-plate: rgba(255,255,255,0.28);
    --accent:#2fbf89;
    --muted:#466a5a;
    --shadow: 0 6px 18px rgba(2,6,23,0.18);
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));}
  canvas{display:block;width:100vw;height:100vh;}
  /* Start overlay */
  #startOverlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; background: linear-gradient(180deg, rgba(2,6,23,0.45), rgba(2,6,23,0.25));}
  .card{background:var(--ui-plate); padding:18px; border-radius:12px; width:460px; text-align:center; box-shadow:var(--shadow); color:#023427}
  .card h1{margin:8px 0 6px 0}
  .card p{margin:0 0 12px 0; color:var(--muted)}
  .startBtn{padding:12px 20px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer;box-shadow:0 6px 12px rgba(0,0,0,0.15)}
  /* Controls (round buttons) */
  #controls{position:fixed; left:18px; top:18px; display:flex; flex-direction:column; gap:10px; z-index:50}
  .circleBtn{
    width:60px;height:60px;border-radius:50%;display:grid;place-items:center;font-size:22px;border:none;cursor:pointer;
    background:linear-gradient(180deg,white,rgba(255,255,255,0.9)); box-shadow: var(--shadow); border:1px solid rgba(0,0,0,0.06);
  }
  .circleBtn:active{transform:scale(0.98)}
  .circleBtn.small{width:48px;height:48px;font-size:18px}
  .labelSmall{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
  /* Stats panel */
  #panel{position:fixed; right:18px; top:18px; width:240px; padding:12px;border-radius:12px;background:var(--ui-plate);backdrop-filter: blur(6px);box-shadow:var(--shadow);z-index:50}
  #panel h3{margin:0 0 8px 0;color:#063e2f}
  .statRow{display:flex;justify-content:space-between;padding:6px 0;font-size:14px;color:#022}
  .units{font-size:11px;color:#3b6b59}
  /* Factory large background icon */
  #factoryIcon{position:fixed; right:40px; bottom:6px; font-size:150px; opacity:1; z-index:20; pointer-events:none}
  /* Small clickable factory (overlay) */
  #factoryClick{position:fixed; right:98px; bottom:38px; width:100px; height:100px; border-radius:10px; background:transparent; z-index:55; cursor:pointer; display:grid; place-items:center}
  /* Equation popup */
  #equation{position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); padding:12px 18px; border-radius:10px; background:rgba(0,0,0,0.6); color:white; font-weight:700; display:none; z-index:70}
  /* Graph */
  #graph{width:100%;height:48px;border-radius:6px; background:transparent;margin-top:8px}
  /* footer note */
  #note{position:fixed; left:18px; bottom:18px; color:rgba(0,0,0,0.6); font-size:12px; z-index:50}
  @media (max-width:700px){
    #panel{display:none}
  }
</style>
</head>
<body>

<div id="startOverlay">
  <div class="card">
    <h1>Simulador de Fotos√≠ntesis</h1>
    <p>Grupo 2: Procesos Naturales y Compensaci√≥n Ambiental<br>
    ¬øCu√°nto CO‚ÇÇ absorbe un √°rbol promedio?</p>
    Usa CO‚ÇÇ + H‚ÇÇO para crear Glucosa (manzana) + ox√≠geno<br><br>
    <button class="startBtn" id="startBtn">INICIAR SIMULACI√ìN</button>
  </div>
</div>

<canvas id="canvas"></canvas>

<div id="controls" style="display:none">
  <button class="circleBtn" id="btnCO2" title="A√±adir CO‚ÇÇ"><b>CO‚ÇÇ</b></button>
  <button class="circleBtn" id="btnH2O" title="A√±adir H‚ÇÇO">üíß</button>
  <button class="circleBtn" id="btnTree" title="Agregar √°rbol">üå≥</button>
  <button class="circleBtn" id="btnPhoto" title="Fotos√≠ntesis">üçÉ</button>
</div>

<div id="panel" style="display:none">
  <h3>Estad√≠sticas</h3>
  <div class="statRow"><div>CO‚ÇÇ (molec.)</div><div id="co2Count">0</div></div>
  <div class="statRow"><div>H‚ÇÇO (molec.)</div><div id="h2oCount">0</div></div>
  <div class="statRow"><div>O‚ÇÇ producido (molec.)</div><div id="o2Count">0</div></div>
  <div class="statRow"><div>√Årboles</div><div id="treeCount">0</div></div>
  <div class="statRow"><div>F√°bricas</div><div id="factoryCount">0</div></div>
  <canvas id="graph"></canvas>
</div>

<div id="factoryIcon">üè≠</div>
<div id="factoryClick" title="Click para emitir CO‚ÇÇ"></div>

<div id="equation">
  6CO<sub>2</sub> + 6H<sub>2</sub>O + luz ‚Üí C<sub>6</sub>H<sub>12</sub>O<sub>6</sub> + 6O<sub>2</sub>
</div>

<div id="note" style="display:none"></div>

<script>
/* =========================
   Canvas setup & global state
   ========================= */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
resize(); window.addEventListener('resize', resize);

let molecules = []; 
let trees = [];     
let factories = 0;
let o2Produced = 0;
let nextId = 1;
let running = false;
const GROUND_HEIGHT = 48; // Altura del suelo

// constants for approximations
const NA = 6.022e23; 
const MW_CO2 = 44.01; 
const SCALE_FACTOR = 0.35; // Escala reducida para mol√©culas

// molecule defs for drawing atoms & bonds
const DEFS = {
  CO2:   { label:'CO‚ÇÇ', atoms:[{ax:-28,ay:0,rad:14,color:'#2abafa',label:'O'},{ax:0,ay:0,rad:16,color:'#333',label:'C'},{ax:28,ay:0,rad:14,color:'#2abafa',label:'O'}], bonds:[[0,1],[1,2]] },
  H2O:   { label:'H‚ÇÇO', atoms:[{ax:-18,ay:10,rad:8,color:'#3aa6fc',label:'H'},{ax:18,ay:10,rad:8,color:'#3aa6fc',label:'H'},{ax:0,ay:-12,rad:14,color:'#2abafa',label:'O'}], bonds:[[2,0],[2,1]] },
  O2:    { label:'O‚ÇÇ', atoms:[{ax:-18,ay:0,rad:14,color:'#2abafa',label:'O'},{ax:18,ay:0,rad:14,color:'#2abafa',label:'O'}], bonds:[[0,1]] },
};

/* =========================
   Utilities
   ========================= */
function spawnMolecule(type,x,y,vx= (Math.random()*2-1)*0.6, vy=(Math.random()*2-1)*0.4, lifetime=0){
  const m = { id: nextId++, type, x, y, vx, vy, homeTo:null, alpha:1, spawnTime:Date.now(), lifetime };
  molecules.push(m);
  return m;
}
function countType(t){ return molecules.filter(m=>m.type===t).length; }

/* =========================
   Initial state + helpers
   ========================= */
function ensureOneTree(){
  if (trees.length === 0) {
    addTreeAtRandom();
  }
}

/* =========================
   Drawing functions
   ========================= */
function drawMolecule(m){
  const def = DEFS[m.type];
  if(!def) return;
  ctx.save();
  ctx.globalAlpha = m.alpha;
  ctx.translate(m.x, m.y);
  // bonds
  ctx.strokeStyle = 'rgba(20,30,40,0.85)';
  ctx.lineWidth = 3 * SCALE_FACTOR;
  def.bonds.forEach(b=>{
    const a1 = def.atoms[b[0]], a2 = def.atoms[b[1]];
    ctx.beginPath(); ctx.moveTo(a1.ax,a1.ay); ctx.lineTo(a2.ax,a2.ay); ctx.stroke();
  });
  // atoms
  def.atoms.forEach(a=>{
    ctx.beginPath(); ctx.fillStyle = a.color; ctx.arc(a.ax,a.ay,a.rad,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#fff'; 
    ctx.font='12px Arial'; // mantener texto visible
    ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(a.label, a.ax, a.ay+1);
  });
  ctx.restore();
}

function drawTree(t){
  // Posici√≥n Y basada en la altura del suelo GROUND_HEIGHT
  const baseY = canvas.height - GROUND_HEIGHT; 
  const trunkW = 8 + 6 * t.size;
  const trunkH = 36 + 40 * t.size;
  const crownR = 28 + 30 * t.size;
  const baseX = t.x;
  
  // shadow
  ctx.beginPath(); ctx.fillStyle='rgba(0,0,0,0.12)';
  ctx.ellipse(baseX+6, baseY+6, crownR*0.9, crownR*0.4, 0,0,Math.PI*2); ctx.fill();
  // trunk
  ctx.fillStyle = '#8b5a2b'; ctx.fillRect(baseX - trunkW/2, baseY - trunkH, trunkW, trunkH);
  // crown
  ctx.beginPath(); ctx.fillStyle = `rgba(34,139,34,${0.6 + 0.4*t.size})`; 
  ctx.arc(baseX, baseY - trunkH - crownR*0.1, crownR, 0, Math.PI*2); ctx.fill();
  // leaves layers
  ctx.beginPath(); ctx.fillStyle = `rgba(46,160,45,${0.35 + 0.55*t.size})`; 
  ctx.arc(baseX - crownR*0.36, baseY - trunkH - crownR*0.3, crownR*0.6, 0, Math.PI*2);
  ctx.arc(baseX + crownR*0.36, baseY - trunkH - crownR*0.35, crownR*0.55, 0, Math.PI*2); ctx.fill();
  
  // stored carbon label
  ctx.font = `${12 + Math.round(6*t.size)}px Arial`; ctx.fillStyle='black'; ctx.textAlign='center';
  ctx.fillText(Math.round(t.stored) + ' C', baseX, baseY - trunkH - crownR - 6);
  
  // draw apples fixed
  t.apples.forEach(a=>{
    ctx.beginPath(); ctx.fillStyle='#d62828'; ctx.arc(a.x,a.y,7,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.fillStyle='#2b8a3e'; ctx.ellipse(a.x+4,a.y-6,3.5,1.8,-0.7,0,Math.PI*2); ctx.fill();
  });
}

/* =========================
   Update physics & homing
   ========================= */
function applyHomingAndUpdate(){
  const now = Date.now();
  for(let i=molecules.length-1;i>=0;i--){
    const m = molecules[i];
    
    // alpha & lifetime handling (compute alpha before removal so fade is visible)
    if (m.lifetime){
      const elapsed = now - m.spawnTime;
      const frac = Math.max(0, Math.min(1, elapsed / m.lifetime));
      m.alpha = 1 - frac;
      // gentle upward motion for O2-like particles
      if (m.type === 'O2') m.vy -= 0.03;
      if (elapsed > m.lifetime + 250){ // small buffer to allow fade-out to reach 0
        molecules.splice(i,1);
        continue;
      }
    }

    if (m.homeTo){
      // move toward home target smoothly
      const dx = m.homeTo.x - m.x;
      const dy = m.homeTo.y - m.y;
      m.x += dx * 0.08;
      m.y += dy * 0.08;
      m.vx *= 0.9; m.vy *= 0.9;
    } else {
      // free drift
      m.x += m.vx;
      m.y += m.vy;
      // slight random drift
      m.vx += (Math.random()*2-1)*0.01;
      m.vy += (Math.random()*2-1)*0.01;
    }

    // boundaries
    const bound = 20;
    if (m.x < bound) { m.x = bound; m.vx = Math.abs(m.vx)*0.6; }
    if (m.x > canvas.width - bound) { m.x = canvas.width - bound; m.vx = -Math.abs(m.vx)*0.6; }
    if (m.y < bound) { m.y = bound; m.vy = Math.abs(m.vy)*0.6; }
    if (m.y > canvas.height - GROUND_HEIGHT - bound) { 
        m.y = canvas.height - GROUND_HEIGHT - bound; 
        m.vy = -Math.abs(m.vy)*0.6; 
    }
  }
}

/* =========================
   Photosynthesis logic
   ========================= */
function startPhotosynthesis(){
  if (trees.length === 0){
    alert('Agrega al menos un √°rbol (üå≥).');
    return;
  }

  // show equation
  const eq = document.getElementById('equation');
  eq.style.display = 'block';
  setTimeout(()=> eq.style.display = 'none', 2400);

  // Number of full photosynthesis-sets available
  const availableCO2 = molecules.filter(m=>m.type==='CO2' && !m.homeTo).length;
  const availableH2O = molecules.filter(m=>m.type==='H2O' && !m.homeTo).length;
  const maxTreesCanProcess = Math.min(trees.length, Math.floor(availableCO2/6), Math.floor(availableH2O/6));

  // If none can process, exit
  if (maxTreesCanProcess === 0) return;

  // Process that many trees (choose nearest trees or first N)
  const treesToProcess = trees.slice(0, maxTreesCanProcess);

  treesToProcess.forEach(t => {
    // take 6 CO2 and 6 H2O that are not already assigned
    const CO2set = molecules.filter(m=>m.type==='CO2' && !m.homeTo).slice(0,6);
    const H2Oset = molecules.filter(m=>m.type==='H2O' && !m.homeTo).slice(0,6);
    if (CO2set.length < 6 || H2Oset.length < 6) return; // safety

    const trunkH = 36 + 40 * t.size;
    const crownR = 28 + 30 * t.size;
    const targetX = t.x;
    const targetY = canvas.height - GROUND_HEIGHT - trunkH - crownR*0.5; // Centro de la copa

    CO2set.concat(H2Oset).forEach(m=>{
      m.homeTo = { x: targetX + (Math.random()*40-20), y: targetY + (Math.random()*20-10) };
      m.vx = 0; m.vy = 0;
    });

    // after short delay, remove used molecules and produce outputs
    setTimeout(()=>{
      const usedIds = new Set(CO2set.concat(H2Oset).map(x=>x.id));
      molecules = molecules.filter(m => !usedIds.has(m.id));

      // update tree: stored carbon and growth
      t.stored += 6;
      t.size = 0.6 + Math.min(1, t.stored / 30); // Crecimiento limitado

      const newTrunkH = 36 + 40 * t.size;
      const newCrownR = 28 + 30 * t.size;
      const ax = t.x + ((t.apples.length % 5 - 2) * 16);
      const ay = canvas.height - GROUND_HEIGHT - newTrunkH - newCrownR/2 - (Math.floor(t.apples.length/5) * 10);
      t.apples.push({ x: Math.round(ax), y: Math.round(ay) });

      // produce 6 O2 ‚Äî each O2 has lifetime 3000 ms
      for (let i=0;i<6;i++){
        const ox = spawnMolecule('O2', t.x + (Math.random()*40-20), canvas.height - GROUND_HEIGHT - newTrunkH - newCrownR - 10 + (Math.random()*30-15), (Math.random()*1-0.5)*0.6, -0.8 - Math.random()*0.6, 3000);
        o2Produced++;
      }

      updatePanel();
      recordCO2History();

    }, 1200);
  }); // end forEach treesToProcess
}

/* =========================
   Trees placement (no overlap)
   ========================= */
function canPlaceTreeAt(x,minDist){
  for(const t of trees) if (Math.abs(t.x - x) < minDist) return false;
  return true;
}
function addTreeAtRandom(){
  const minDist = 170;
  let attempts = 0;
  let t = null;
  while(attempts < 40){
    const x = 80 + Math.random()*(canvas.width - 160);
    if (canPlaceTreeAt(x, minDist)){
      const size = 0.6 + Math.random()*0.5;
      t = { x: x, y: canvas.height - GROUND_HEIGHT, size: size, stored:0, apples:[] }; // Y es la base
      break;
    }
    attempts++;
  }
  // fallback place anyway
  if (!t) {
    const x = 80 + Math.random()*(canvas.width - 160);
    const size = 0.6 + Math.random()*0.5;
    t = { x: x, y: canvas.height - GROUND_HEIGHT, size: size, stored:0, apples:[] };
  }
  trees.push(t); updatePanel(); return t;
}

/* =========================
   Panel / stats / graph
   ========================= */
const elCo2 = document.getElementById('co2Count');
const elCo2Mass = document.getElementById('co2Mass');
const elH2o = document.getElementById('h2oCount');
const elO2 = document.getElementById('o2Count');
const elTrees = document.getElementById('treeCount');
const elFactories = document.getElementById('factoryCount');
const graphCanvas = document.getElementById('graph');
const graphCtx = graphCanvas.getContext('2d');

let co2History = []; 

function updatePanel(){
  elCo2.textContent = countType('CO2');
  const count = countType('CO2');
  elH2o.textContent = countType('H2O');
  elO2.textContent = o2Produced;
  elTrees.textContent = trees.length;
  elFactories.textContent = factories;
  drawGraph();
}

// record history every second
setInterval(()=>{
  if (!running) return;
  co2History.push(countType('CO2'));
  if (co2History.length > 120) co2History.shift();
  drawGraph();
}, 1000);

function drawGraph(){
  const w = graphCanvas.width = graphCanvas.clientWidth || 200;
  const h = graphCanvas.height = graphCanvas.clientHeight || 48;
  graphCtx.clearRect(0,0,w,h);
  if (co2History.length < 2) return;
  const max = Math.max(...co2History) + 1;
  graphCtx.beginPath();
  graphCtx.strokeStyle = '#2fbf89';
  graphCtx.lineWidth = 2;
  co2History.forEach((v,i)=>{
    const x = i * (w / (co2History.length - 1));
    const y = h - (v / max) * h;
    if (i===0) graphCtx.moveTo(x,y); else graphCtx.lineTo(x,y);
  });
  graphCtx.stroke();
}

/* =========================
   Factory click handler (clickable overlay)
   ========================= */
const factoryClick = document.getElementById('factoryClick');
factoryClick.addEventListener('click', ()=>{
  factories++; updatePanel();
  for (let i = 0; i < 4; i++) {
   spawnMolecule("CO2", x, y, vx, vy);
}
  recordCO2History(); 
});

/* =========================
   Helper: spawn initial tree & molecules on start
   ========================= */
function startSimulation(){
  // Ocultar Overlay
  document.getElementById('startOverlay').style.display = 'none';
  // Mostrar UI
  document.getElementById('controls').style.display = 'flex';
  document.getElementById('panel').style.display = 'block';
  document.getElementById('note').style.display = 'block';
  // initial tree guaranteed
  ensureOneTree();
  // spawn initial molecules: 4 CO2, 2 H2O (educational starter)
  if (molecules.length === 0){
    for(let i=0;i<4;i++) spawnMolecule('CO2', Math.random()*canvas.width, Math.random()*canvas.height*0.35 + 60, (Math.random()*0.8)-0.4, (Math.random()*0.4)-0.2);
    for(let i=0;i<4;i++) spawnMolecule('H2O', Math.random()*canvas.width, Math.random()*canvas.height*0.35 + 60, (Math.random()*0.8)-0.4, (Math.random()*0.4)-0.2);
  }
  running = true;
  recordCO2History();
  updatePanel();
}

/* =========================
   Graph immediate record
   ========================= */
function recordCO2History(){
  co2History.push(countType('CO2'));
  if (co2History.length > 120) co2History.shift();
  drawGraph();
}

/* =========================
   Main loop: update & render
   ========================= */
function update(){
  applyHomingAndUpdate();
}
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // sky subtle 
  const g = ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0,'rgba(255,255,255,0.03)');
  g.addColorStop(1,'rgba(0,0,0,0.02)');
  ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);

  // ground
  ctx.fillStyle = '#2f6f2c'; ctx.fillRect(0, canvas.height - GROUND_HEIGHT, canvas.width, GROUND_HEIGHT);

  // draw trees first so molecules are in front
  for(const t of trees) drawTree(t);
  
  // draw molecules
  for(const m of molecules) drawMolecule(m);
}

function loop(){
  if (running){
    update();
    render();
  }
  requestAnimationFrame(loop);
}
loop();

/* =========================
   UI wiring
   ========================= */
document.getElementById('startBtn').addEventListener('click', ()=>{ startSimulation(); });
document.getElementById('btnCO2').addEventListener('click', ()=>{ spawnMolecule('CO2', Math.random()*canvas.width, 60); recordCO2History(); updatePanel(); });
document.getElementById('btnH2O').addEventListener('click', ()=>{ spawnMolecule('H2O', Math.random()*canvas.width, 60, (Math.random()*0.6)-0.3, 0.2); updatePanel(); });
document.getElementById('btnTree').addEventListener('click', ()=>{ addTreeAtRandom(); updatePanel(); });
document.getElementById('btnPhoto').addEventListener('click', ()=>{ startPhotosynthesis(); });

/* =========================
   Small niceties
   ========================= */
function updateStats(){ updatePanel(); }
updatePanel();
document.getElementById("factoryClick").addEventListener("click", () => {
  // Crear varias mol√©culas de CO‚ÇÇ cerca de la f√°brica
  for (let i = 0; i < 4; i++) {
    spawnMolecule(
      "CO2",
      canvas.width - 120 + Math.random() * 40,
      canvas.height - GROUND_HEIGHT - 100 + Math.random() * 40,
      (Math.random() * 1.2 - 0.6),
      (Math.random() * -0.6)
    );
  }

  factories++;   // ‚Üê Aumenta el contador de f√°bricas
  updatePanel(); // ‚Üê Actualiza los n√∫meros en la tarjeta
  recordCO2History();
});

</script>
</body>
</html>
